<!DOCTYPE html>
<html>
<head>
  <title>Character Sheet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    h2 {
      text-align: center;
    }
    .row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .col {
      flex: 1 1 45%;
      margin: 10px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input[type=text], input[type=number], select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .stats-table, .skills-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .stats-table th, .stats-table td, .skills-table th, .skills-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .btn-row button {
      margin-right: 10px;
    }
    #hp-speed {
      margin-top: 20px;
      font-size: 1.1em;
    }
    .affinities {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }
    .affinities div {
      background-color: #e3e3e3;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Character Sheet</h2>

    <div class="row">
      <div class="col">
        <label>Name</label>
        <input type="text" id="char-name">

        <label>Race</label>
        <input type="text" id="char-race">

        <label>Position</label>
        <select id="char-position" onchange="updateFromTextbox()">
          <option value="Guide">Guide</option>
          <option value="Fisherman">Fisherman</option>
          <option value="Spear Bearer">Spear Bearer</option>
          <option value="Wave Controller">Wave Controller</option>
          <option value="Light Bearer">Light Bearer</option>
          <option value="Anima">Anima</option>
        </select>

        <label>Primary Stats</label>
        <div class="affinities" id="primary-affinities"></div>
        <select id="add-primary"></select>

        <label>Secondary Stats</label>
        <div class="affinities" id="secondary-affinities"></div>
        <select id="add-secondary"></select>

        <label>Tertiary Stats</label>
        <div class="affinities" id="tertiary-affinities"></div>
        <select id="add-tertiary"></select>

        <label>Level</label>
        <input type="number" id="char-level" min="1" value="1" onchange="updateFromTextbox()">

        <label>Floor</label>
        <input type="number" id="char-floor" min="1" value="1" onchange="renderHpSpeed()">

        <label>Stat Point Multiplier</label>
        <input type="number" id="stat-multiplier" min="1" step="0.1" value="1.5">
      </div>

      <div class="col">
        <label>Available Stat Points</label>
        <input type="number" id="available-stat-points" value="0" readonly>

        <label>Available Skill Points</label>
        <input type="number" id="available-skill-points" value="0" readonly>

        <div class="btn-row">
          <button onclick="levelUp()">Level Up</button>
          <button onclick="addSkillPoint()">+1 Skill Point</button>
        </div>

        <div class="btn-row">
          <button onclick="addSkillSlot(1)">+ Tier 1 Slot</button>
          <button onclick="addSkillSlot(2)">+ Tier 2 Slot</button>
          <button onclick="addSkillSlot(3)">+ Tier 3 Slot</button>
          <button onclick="addSkillSlot(4)">+ Tier 4 Slot</button>
          <button onclick="addSkillSlot(5)">+ Tier 5 Slot</button>
        </div>
      </div>
    </div>

    <div id="hp-speed"></div>

    <h3>Stats</h3>
    <table class="stats-table" id="stats-table">
      <thead>
        <tr>
          <th>Stat</th>
          <th>Value</th>
          <th>+1</th>
        </tr>
      </thead>
      <tbody id="stats-body"></tbody>
    </table>

    <h3>Skill Slots</h3>
    <table class="skills-table" id="skills-table">
      <thead>
        <tr><th>Tier</th><th>Skill</th></tr>
      </thead>
      <tbody id="skills-body"></tbody>
    </table>
  </div>

  <script>
    const stats = ["Strength", "Shinsu Control", "Shinsu Endurance", "Perception", "Willpower", "Technique", "Insight", "Authority"];
    const state = {
      statValues: Object.fromEntries(stats.map(stat => [stat, 1])),
      statHistory: [],
      skillSlots: [],
      availableStatPoints: 0,
      availableSkillPoints: 0,
      affinities: { primary: [], secondary: [], tertiary: [] }
    };

    function renderAffinityControls() {
      ["primary", "secondary", "tertiary"].forEach(type => {
        const container = document.getElementById(`${type}-affinities`);
        const select = document.getElementById(`add-${type}`);
        container.innerHTML = "";
        select.innerHTML = "<option value=''>+ Add</option>" + stats.map(stat => `<option value="${stat}">${stat}</option>`).join("");

        state.affinities[type].forEach(stat => {
          const div = document.createElement("div");
          div.textContent = stat;
          div.onclick = () => {
            state.affinities[type] = state.affinities[type].filter(s => s !== stat);
            updateFromTextbox();
          };
          container.appendChild(div);
        });

        select.onchange = e => {
          const val = e.target.value;
          if (val && !state.affinities[type].includes(val)) {
            state.affinities[type].push(val);
            updateFromTextbox();
          }
        };
      });
    }

    function getGrowthTable() {
          return {
            Guide: [
              { range: [1, 10], primary: 1, secondary: 0.5, tertiary: 0.5 },
              { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
              { range: [26, 50], primary: 1.5, secondary: 1, tertiary: 0.5 },
              { range: [51, 80], primary: 2, secondary: 1.5, tertiary: 1 },
              { range: [81, 110], primary: 2.5, secondary: 2, tertiary: 1 },
              { range: [111, 140], primary: 3, secondary: 2, tertiary: 1.5 },
              { range: [141, 170], primary: 3, secondary: 2.5, tertiary: 2 },
              { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }
            ],
            Fisherman: [
              { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
              { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
              { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
              { range: [51, 80], primary: 2, secondary: 2, tertiary: 1 },
              { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
              { range: [111, 140], primary: 3, secondary: 2, tertiary: 2 },
              { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
              { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }
            ],
            "Spear Bearer": [
              { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
              { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
              { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
              { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
              { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
              { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
              { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
              { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
            ],
            "Wave Controller": [
              { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
              { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
              { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
              { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
              { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
              { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
              { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
              { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
            ],
            "Light Bearer": [
              { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
              { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
              { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
              { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
              { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
              { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
              { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
              { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
            ],
            Anima: [
              { range: [1, 10], primary: 2, secondary: 1, tertiary: 0.5 },
              { range: [11, 25], primary: 2.5, secondary: 1, tertiary: 0.5 },
              { range: [26, 50], primary: 3, secondary: 1, tertiary: 0.5 },
              { range: [51, 80], primary: 3.5, secondary: 1.5, tertiary: 1 },
              { range: [81, 110], primary: 4, secondary: 1.5, tertiary: 1 },
              { range: [111, 140], primary: 5, secondary: 2, tertiary: 1.5 },
              { range: [141, 170], primary: 6, secondary: 2, tertiary: 1.5 },
              { range: [171, Infinity], primary: 6, secondary: 2, tertiary: 2 }
            ]
          };
        }

    function getGrowthRatesForLevel(position, level) {
      const table = getGrowthTable()[position] || [];
      return table.find(r => level >= r.range[0] && level <= r.range[1]) || { primary: 0, secondary: 0, tertiary: 0 };
    }

    function updateFromTextbox() {
      const level = parseInt(document.getElementById("char-level").value);
      const pos = document.getElementById("char-position").value;
      const priList = state.affinities.primary;
      const secList = state.affinities.secondary;
      const terList = state.affinities.tertiary;

      stats.forEach(stat => state.statValues[stat] = 1);

      for (let i = 1; i <= level; i++) {
        const rates = getGrowthRatesForLevel(pos, i);
        priList.forEach(stat => state.statValues[stat] += rates.primary / priList.length);
        secList.forEach(stat => state.statValues[stat] += rates.secondary / secList.length);
        terList.forEach(stat => state.statValues[stat] += rates.tertiary / terList.length);
      }

      state.availableStatPoints = level - 1;
      state.availableSkillPoints = level - 1;
      document.getElementById("available-stat-points").value = state.availableStatPoints;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
      renderStats();
      renderHpSpeed();
      renderAffinityControls();
    }

    function renderStats() {
      const tbody = document.getElementById("stats-body");
      tbody.innerHTML = "";
      const average = stats.reduce((sum, stat) => sum + state.statValues[stat], 0) / stats.length;
      const max = parseFloat(document.getElementById("stat-multiplier").value) * average;

      stats.forEach(stat => {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.textContent = stat;
        const td2 = document.createElement("td");
        td2.textContent = state.statValues[stat].toFixed(1);
        const td3 = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "+";
        btn.onclick = () => {
          if (state.availableStatPoints > 0 && state.statValues[stat] + 1 <= Math.floor(max)) {
            state.statValues[stat]++;
            state.availableStatPoints--;
            renderStats();
            document.getElementById("available-stat-points").value = state.availableStatPoints;
            renderHpSpeed();
          }
        };
        td3.appendChild(btn);

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tbody.appendChild(tr);
      });
    }

    function renderHpSpeed() {
      const floor = parseInt(document.getElementById("char-floor").value);
      const level = parseInt(document.getElementById("char-level").value);
      const se = state.statValues["Shinsu Endurance"];
      const str = state.statValues["Strength"];
      const wp = state.statValues["Willpower"];

      const movePenalty = Math.max(0, 2 * floor - se);
      const speed = 6 + level - movePenalty;

      let hpMultiplier = 2 + Math.floor(level / 25);
      const hp = 3 * se + 2 * str + 1.5 * wp + level * hpMultiplier;

      document.getElementById("hp-speed").innerHTML = `<b>HP:</b> ${Math.round(hp)}<br><b>Movement Speed:</b> ${speed}`;
    }

    function addSkillPoint() {
      state.availableSkillPoints++;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
    }

    function levelUp() {
      document.getElementById("char-level").value++;
      updateFromTextbox();
    }

    function addSkillSlot(tier) {
      state.skillSlots.push({ tier: tier, name: "" });
      state.skillSlots.sort((a, b) => a.tier - b.tier);
      renderSkills();
    }

    function renderSkills() {
      const tbody = document.getElementById("skills-body");
      tbody.innerHTML = "";
      state.skillSlots.forEach((slot, index) => {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.textContent = `Tier ${slot.tier}`;
        const td2 = document.createElement("td");
        const input = document.createElement("input");
        input.value = slot.name;
        input.onchange = e => state.skillSlots[index].name = e.target.value;
        td2.appendChild(input);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tbody.appendChild(tr);
      });
    }

    // Initialize
    renderAffinityControls();
    updateFromTextbox();
    renderSkills();
  </script>
</body>
</html>
